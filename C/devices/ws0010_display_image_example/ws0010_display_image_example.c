#include "pch.h"

/*
* Use Ctrl+C to stop the program gracefully.
*/

static int stop = 0;

static void
signal_handler(int signal)
{
    stop = 1;
}

int main(int argc, char* argv[])
{
    t_ws0010 display;
    qsigaction_t action;
    t_error result;

    /* Install a Ctrl+C handler */
    action.sa_handler = signal_handler;
    action.sa_flags = 0;
    qsigemptyset(&action.sa_mask);

    qsigaction(SIGINT, &action, NULL);

    printf("Press Ctrl+C to exit gracefully\n");
    fflush(stdout);

    /* Open the WS0010 OLED display in graphics mode. On QBot Platform use the URI: "lcd://localhost:1".  */
    result = ws0010_open("spi://localhost:0?baud=2e6,word=10,polarity=1,phase=1,frame=56", true, &display);
    if (result >= 0)
    {
        do
        {
            static t_uint8 logo[80][16] =
            {
                {   0,   0,   0,   0,   0, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0,   0 },
                {   0,   0,   0, 255, 255, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0 },
                {   0,   0, 255, 255, 255, 255,   0,   0,   0,   0, 255, 255, 255,   0,   0,   0 },
                {   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255, 255,   0 },
                {   0, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0 },
                {   0, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0 },
                {   0, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0 },
                {   0, 255, 255,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0, 255, 255,   0 },
                {   0, 255, 255,   0,   0,   0,   0,   0,   0, 255, 255, 255, 255, 255, 255,   0 },
                {   0, 255, 255, 255,   0,   0,   0,   0, 255, 255,   0, 255, 255, 255,   0,   0 },
                {   0,   0, 255, 255, 255,   0,   0,   0,   0, 255, 255, 255, 255, 255, 255,   0 },
                {   0,   0,   0, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,   0 },
                {   0,   0,   0,   0, 255, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0, 255, 255,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0, 255, 255, 255, 255, 255,   0,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0, 255, 255,   0,   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255, 255,   0,   0,   0, 255, 255,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0, 255,   0,   0,   0,   0, 255, 255,   0,   0,   0,   0, 255,   0,   0,   0 },
                {   0, 255,   0,   0,   0,   0, 255, 255,   0,   0,   0,   0,   0, 255,   0,   0 },
                {   0, 255, 255,   0,   0, 255, 255,   0,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0, 255, 255, 255,   0,   0, 255,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0,   0,   0,   0,   0,   0, 255, 255,   0,   0,   0, 255,   0,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0, 255, 255,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0,   0,   0,   0,   0,   0, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0, 255, 255, 255,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255, 255,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0, 255, 255, 255,   0,   0,   0,   0, 255, 255, 255,   0 },
                {   0,   0,   0, 255, 255, 255, 255,   0,   0,   0,   0, 255,   0, 255,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0,   0, 255, 255, 255,   0 },
                {   0, 255, 255,   0,   0, 255, 255,   0,   0,   0,   0, 255,   0,   0,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0,   0, 255, 255, 255, 255, 255,   0,   0,   0,   0, 255,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0, 255,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0, 255,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0, 255, 255, 255,   0,   0,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0,   0,   0,   0, 255, 255, 255,   0,   0,   0,   0, 255, 255,   0, 255,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0, 255, 255,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255,   0,   0, 255,   0 },
                {   0,   0, 255, 255,   0,   0, 255,   0,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0, 255, 255, 255, 255,   0, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255, 255,   0, 255,   0, 255, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255, 255,   0, 255,   0, 255, 255,   0,   0,   0, 255, 255, 255,   0,   0 },
                {   0, 255, 255,   0, 255,   0, 255, 255,   0,   0,   0,   0,   0,   0, 255,   0 },
                {   0,   0, 255,   0, 255, 255, 255,   0,   0,   0,   0,   0,   0,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255, 255,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0, 255,   0,   0, 255,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0, 255,   0,   0, 255,   0 },
                {   0, 255,   0,   0, 255,   0,   0, 255,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255,   0,   0, 255,   0,   0, 255,   0,   0,   0,   0, 255, 255, 255,   0 },
                {   0, 255,   0,   0, 255,   0,   0, 255,   0,   0,   0, 255,   0, 255,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0, 255, 255, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0, 255, 255, 255, 255, 255, 255, 255,   0,   0,   0, 255,   0,   0,   0,   0 },
                {   0, 255,   0,   0, 255,   0,   0,   0,   0,   0,   0, 255, 255, 255, 255,   0 },
                {   0, 255,   0,   0, 255,   0,   0,   0,   0,   0,   0, 255,   0,   0,   0,   0 },
                {   0, 255,   0,   0, 255,   0,   0,   0,   0,   0,   0,   0, 255, 255,   0,   0 },
                {   0,   0, 255, 255, 255, 255, 255,   0,   0,   0,   0, 255, 255,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0, 255, 255,   0,   0,   0, 255, 255,   0, 255,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
                {   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0 },
            };
            t_timeout pause = { 0, 20000000, false }; /* 0.02 seconds */
            t_int pixel_column = ARRAY_LENGTH(logo);

            while (!stop)
            {
                result = ws0010_draw_image(display, 0, pixel_column, ARRAY_LENGTH(logo), ARRAY_LENGTH(logo[0]), &logo[0][0]);
                if (result < 0)
                    break;

                qtimer_sleep(&pause);

                --pixel_column;
                if (pixel_column < -(t_int)ARRAY_LENGTH(logo))
                    pixel_column = ARRAY_LENGTH(logo);
            }

        } while (false);

        /* Close the display */
        ws0010_close(display);
    }

    if (result < 0)
    {
        char message[256];
        msg_get_error_messageA(NULL, result, message, ARRAY_LENGTH(message));
        fprintf(stderr, "ERROR: Unable to write to display. %s (result=%d)\n", message, result);
    }

    return result;
}
